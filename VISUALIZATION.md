# ğŸ“Š TRá»°C QUAN HÃ“A Há»† THá»NG - Tá»° Äá»˜NG Há»¦Y ÄÆ N HÃ€NG

## ğŸ¯ Bá»©c tranh toÃ n cáº£nh

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         HÃ€NH TRÃŒNH Cá»¦A Má»˜T ÄÆ N HÃ€NG                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ğŸ‘¤ KhÃ¡ch hÃ ng                ğŸ–¥ï¸  Server                   ğŸ° RabbitMQ
        â”‚                           â”‚                           â”‚
        â”‚  1. Táº¡o Ä‘Æ¡n hÃ ng          â”‚                           â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                           â”‚
        â”‚                           â”‚  2. Gá»­i vÃ o queue         â”‚
        â”‚                           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
        â”‚                           â”‚                           â”‚
        â”‚                           â”‚                      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚                           â”‚                      â”‚ PENDING â”‚
        â”‚                           â”‚                      â”‚ â° TTL  â”‚
        â”‚                           â”‚                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                           â”‚                           â”‚
        â”‚â—„â”€â”€â”€â”€â”€â”€Nháº­n thÃ´ng bÃ¡oâ”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€3. Consumerâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   "Vui lÃ²ng thanh toÃ¡n"   â”‚      xá»­ lÃ½                â”‚
        â”‚                           â”‚                           â”‚
        â”‚                                                       â”‚
        â”‚                           â”‚                           â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CASE 1: THANH TOÃN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                           â”‚                           â”‚
        â”‚  4a. Thanh toÃ¡n           â”‚                           â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                           â”‚
        â”‚                           â”‚  5a. Update & send        â”‚
        â”‚                           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
        â”‚                           â”‚                      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚                           â”‚                      â”‚  PAID   â”‚
        â”‚                           â”‚                      â”‚    âœ…   â”‚
        â”‚                           â”‚                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚â—„â”€â”€â”€â”€â”€â”€XÃ¡c nháº­nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€6a. Consumerâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   "Thanh toÃ¡n thÃ nh cÃ´ng" â”‚      xá»­ lÃ½                â”‚
        â”‚                           â”‚                           â”‚
        â”‚                                                       â”‚
        â”‚                           â”‚                           â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CASE 2: Tá»° Äá»˜NG Há»¦Y â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                           â”‚                           â”‚
        â”‚         â° Äá»£i 15 phÃºt...                             â”‚
        â”‚                           â”‚                           â”‚
        â”‚                           â”‚                      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚                           â”‚                      â”‚ PENDING â”‚
        â”‚                           â”‚                      â”‚ EXPIRED â”‚
        â”‚                           â”‚                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                           â”‚                           â”‚
        â”‚                           â”‚                      [DLX route]
        â”‚                           â”‚                           â”‚
        â”‚                           â”‚                      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚                           â”‚                      â”‚CANCELLEDâ”‚
        â”‚                           â”‚                      â”‚    âŒ   â”‚
        â”‚                           â”‚                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚â—„â”€â”€â”€â”€â”€â”€ThÃ´ng bÃ¡oâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€Consumerâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   "ÄÆ¡n hÃ ng Ä‘Ã£ há»§y"       â”‚      xá»­ lÃ½                â”‚
        â”‚                           â”‚                           â”‚
```

## ğŸ—ï¸ Kiáº¿n trÃºc cÃ¡c thÃ nh pháº§n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APPLICATION LAYER                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   REST API   â”‚      â”‚   Service    â”‚      â”‚     DTO      â”‚ â”‚
â”‚  â”‚              â”‚      â”‚              â”‚      â”‚              â”‚ â”‚
â”‚  â”‚ - POST /     â”‚      â”‚ - Save order â”‚      â”‚ - Order      â”‚ â”‚
â”‚  â”‚   create     â”‚â—„â”€â”€â”€â”€â–ºâ”‚ - Get order  â”‚â—„â”€â”€â”€â”€â–ºâ”‚ - Request   â”‚ â”‚
â”‚  â”‚ - POST /pay  â”‚      â”‚ - Update     â”‚      â”‚              â”‚ â”‚
â”‚  â”‚ - POST /     â”‚      â”‚              â”‚      â”‚              â”‚ â”‚
â”‚  â”‚   cancel     â”‚      â”‚              â”‚      â”‚              â”‚ â”‚
â”‚  â”‚ - GET /      â”‚      â”‚              â”‚      â”‚              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Gá»­i/Nháº­n message
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MESSAGING LAYER                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Producer   â”‚                        â”‚   Consumer   â”‚      â”‚
â”‚  â”‚              â”‚                        â”‚              â”‚      â”‚
â”‚  â”‚ - sendTo     â”‚                        â”‚ - handle     â”‚      â”‚
â”‚  â”‚   Pending    â”‚                        â”‚   Pending    â”‚      â”‚
â”‚  â”‚ - sendTo     â”‚                        â”‚ - handle     â”‚      â”‚
â”‚  â”‚   Paid       â”‚                        â”‚   Paid       â”‚      â”‚
â”‚  â”‚ - sendTo     â”‚                        â”‚ - handle     â”‚      â”‚
â”‚  â”‚   Cancelled  â”‚                        â”‚   Cancelled  â”‚      â”‚
â”‚  â”‚              â”‚                        â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                                       â”‚               â”‚
â”‚         â”‚ RabbitTemplate         @RabbitListenerâ”‚              â”‚
â”‚         â”‚                                       â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                       â”‚
          â”‚                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       RABBITMQ BROKER           â”‚               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    order.exchange                          â”‚ â”‚
â”‚  â”‚                  (Direct Exchange)                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚      â”‚                    â”‚                    â”‚                 â”‚
â”‚      â”‚ order.pending      â”‚ order.paid         â”‚ order.cancelled â”‚
â”‚      â”‚                    â”‚                    â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ order.pending    â”‚ â”‚ order.paid       â”‚ â”‚ order.cancelled  â”‚â”‚
â”‚  â”‚ .queue           â”‚ â”‚ .queue           â”‚ â”‚ .queue           â”‚â”‚
â”‚  â”‚                  â”‚ â”‚                  â”‚ â”‚                  â”‚â”‚
â”‚  â”‚ â€¢ TTL: 15min     â”‚ â”‚ âœ… ÄÃ£ thanh toÃ¡n â”‚ â”‚ âŒ ÄÃ£ há»§y        â”‚â”‚
â”‚  â”‚ â€¢ DLX: set       â”‚ â”‚                  â”‚ â”‚                  â”‚â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚      â”‚                                                           â”‚
â”‚      â”‚ Message expire                                           â”‚
â”‚      â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              order.dlx.exchange                           â”‚  â”‚
â”‚  â”‚            (Dead Letter Exchange)                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚      â”‚                                                           â”‚
â”‚      â”‚ order.cancelled                                          â”‚
â”‚      â”‚                                                           â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Cancelled Queue                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Flow Chart Chi Tiáº¿t

```
                    START
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Client táº¡o Ä‘Æ¡n hÃ ng   â”‚
        â”‚   POST /api/orders/     â”‚
        â”‚        create           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Táº¡o Order object       â”‚
        â”‚  orderId = random UUID  â”‚
        â”‚  status = PENDING       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Producer gá»­i message   â”‚
        â”‚  Ä‘áº¿n pending queue      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Message vÃ o queue      â”‚
        â”‚  TTL báº¯t Ä‘áº§u Ä‘áº¿m        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Consumer xá»­ lÃ½         â”‚
        â”‚  - LÆ°u DB               â”‚
        â”‚  - Gá»­i email nháº¯c       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚
         â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Thanh toÃ¡nâ”‚           â”‚KhÃ´ng lÃ m â”‚
    â”‚trong TTL â”‚           â”‚   gÃ¬     â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                      â”‚
         â”‚                      â”‚ TTL expire
         â”‚                      â”‚
         â–¼                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚POST /pay    â”‚     â”‚Message expireâ”‚
    â”‚             â”‚     â”‚â†’ DLX         â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚
          â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Send to paid â”‚     â”‚Route to      â”‚
    â”‚queue        â”‚     â”‚cancelled     â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚queue         â”‚
          â”‚             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚
          â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Consumer:    â”‚     â”‚Consumer:     â”‚
    â”‚handlePaid() â”‚     â”‚handle        â”‚
    â”‚             â”‚     â”‚Cancelled()   â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚
          â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Status = PAIDâ”‚     â”‚Status =      â”‚
    â”‚âœ…          â”‚     â”‚CANCELLED âŒ  â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Gá»­i email/SMS         â”‚
        â”‚   thÃ´ng bÃ¡o káº¿t quáº£     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
                    END
```

## ğŸ“ˆ Timeline Diagram

```
Minute 0                                    Minute 15
â”‚                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  Táº¡o Ä‘Æ¡n                                    Expire â”‚
â”‚     â”‚                                           â”‚  â”‚
â”‚     â–¼                                           â”‚  â”‚
â”‚  â° TTL báº¯t Ä‘áº§u                                 â”‚  â”‚
â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚     â”‚         Chá» thanh toÃ¡n (15 phÃºt)        â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                    â”‚
â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚  â”‚   Thanh toÃ¡n?    â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                             â”‚
â”‚       â”‚        â”‚                                   â”‚
â”‚       â”‚ CÃ“     â”‚ KHÃ”NG                            â”‚
â”‚       â”‚        â”‚                                   â”‚
â”‚       â–¼        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
â”‚   âœ… PAID                                    Expireâ”‚
â”‚   (Káº¿t thÃºc)                                      â”‚
â”‚                                                    â–¼
â”‚                                              âŒ CANCELLED
â”‚                                              (Tá»± Ä‘á»™ng há»§y)
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ChÃº thÃ­ch:
â° TTL Timer Ä‘ang cháº¡y
âœ… Thanh toÃ¡n thÃ nh cÃ´ng â†’ KhÃ´ng bá»‹ há»§y
âŒ Háº¿t TTL â†’ Tá»± Ä‘á»™ng há»§y qua DLX
```

## ğŸ­ State Diagram - Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  START  â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚ create
                         â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”‚  PENDING  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
          â”‚              â”‚              â”‚
          â”‚ cancel       â”‚ TTL expire   â”‚ pay
          â”‚              â”‚              â”‚
          â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ CANCELLED â”‚  â”‚ CANCELLED â”‚  â”‚  PAID  â”‚
    â”‚ (Manual)  â”‚  â”‚  (Auto)   â”‚  â”‚        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚              â”‚              â”‚
          â”‚              â”‚              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   END   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸª CÃ¡c Actor vÃ  Vai trÃ²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SYSTEM ACTORS                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ğŸ‘¤ KhÃ¡ch hÃ ng (Client)                                â”‚
â”‚     â”œâ”€ Táº¡o Ä‘Æ¡n hÃ ng                                    â”‚
â”‚     â”œâ”€ Thanh toÃ¡n Ä‘Æ¡n hÃ ng                             â”‚
â”‚     â””â”€ Há»§y Ä‘Æ¡n hÃ ng                                    â”‚
â”‚                                                         â”‚
â”‚  ğŸŒ REST API (OrderController)                         â”‚
â”‚     â”œâ”€ Nháº­n request tá»« client                          â”‚
â”‚     â”œâ”€ Validate dá»¯ liá»‡u                                â”‚
â”‚     â”œâ”€ Gá»i Producer/Service                            â”‚
â”‚     â””â”€ Tráº£ vá» response                                 â”‚
â”‚                                                         â”‚
â”‚  ğŸ“¤ Producer (OrderProducer)                           â”‚
â”‚     â”œâ”€ Gá»­i message vÃ o RabbitMQ                        â”‚
â”‚     â”œâ”€ Serialize object thÃ nh JSON                     â”‚
â”‚     â””â”€ Set routing key                                 â”‚
â”‚                                                         â”‚
â”‚  ğŸ° RabbitMQ Broker                                    â”‚
â”‚     â”œâ”€ Nháº­n vÃ  lÆ°u trá»¯ message                         â”‚
â”‚     â”œâ”€ Quáº£n lÃ½ TTL                                     â”‚
â”‚     â”œâ”€ Route message qua DLX khi expire                â”‚
â”‚     â””â”€ Deliver message cho consumer                    â”‚
â”‚                                                         â”‚
â”‚  ğŸ“¥ Consumer (OrderConsumer)                           â”‚
â”‚     â”œâ”€ Láº¯ng nghe queue                                 â”‚
â”‚     â”œâ”€ Nháº­n vÃ  xá»­ lÃ½ message                           â”‚
â”‚     â”œâ”€ Cáº­p nháº­t database                               â”‚
â”‚     â””â”€ Gá»­i notification                                â”‚
â”‚                                                         â”‚
â”‚  ğŸ’¾ Service (OrderService)                             â”‚
â”‚     â”œâ”€ Quáº£n lÃ½ business logic                          â”‚
â”‚     â”œâ”€ CRUD operations                                 â”‚
â”‚     â””â”€ LÆ°u trá»¯ dá»¯ liá»‡u (in-memory/DB)                  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ CÃ¡c Scenario Thá»±c Táº¿

### ğŸ“± Scenario E-commerce

```
Thá»© 2, 9:00 AM
â”‚  KhÃ¡ch hÃ ng Ä‘áº·t 1 Ã¡o sÆ¡ mi trÃªn website
â”‚  GiÃ¡: 500,000 VNÄ
â”‚
â”œâ”€â–º Há»‡ thá»‘ng:
â”‚   â€¢ Táº¡o Ä‘Æ¡n hÃ ng ORD-ABC123
â”‚   â€¢ Giá»¯ hÃ ng trong kho
â”‚   â€¢ Gá»­i email: "Vui lÃ²ng thanh toÃ¡n trong 15 phÃºt"
â”‚   â€¢ Message vÃ o pending queue vá»›i TTL = 15 phÃºt
â”‚
â”œâ”€â–º 9:05 AM - KhÃ¡ch hÃ ng thanh toÃ¡n qua VNPay
â”‚   â€¢ API nháº­n webhook tá»« VNPay
â”‚   â€¢ Gá»i POST /api/orders/ORD-ABC123/pay
â”‚   â€¢ ÄÆ¡n hÃ ng chuyá»ƒn sang PAID
â”‚   â€¢ Gá»­i email xÃ¡c nháº­n
â”‚   â€¢ Báº¯t Ä‘áº§u Ä‘Ã³ng gÃ³i vÃ  giao hÃ ng
â”‚
â””â”€â–º Káº¿t quáº£: âœ… ThÃ nh cÃ´ng, hÃ ng Ä‘Æ°á»£c giao
```

### â° Scenario Timeout

```
Thá»© 3, 2:00 PM
â”‚  KhÃ¡ch hÃ ng Ä‘áº·t 1 Ä‘iá»‡n thoáº¡i
â”‚  GiÃ¡: 15,000,000 VNÄ
â”‚
â”œâ”€â–º Há»‡ thá»‘ng:
â”‚   â€¢ Táº¡o Ä‘Æ¡n hÃ ng ORD-XYZ789
â”‚   â€¢ Giá»¯ hÃ ng trong kho
â”‚   â€¢ Gá»­i email nháº¯c nhá»Ÿ
â”‚   â€¢ TTL = 15 phÃºt
â”‚
â”œâ”€â–º 2:01 - 2:14 PM
â”‚   â€¢ KhÃ¡ch hÃ ng do dá»±, chÆ°a thanh toÃ¡n
â”‚   â€¢ Gá»­i SMS nháº¯c: "CÃ²n 5 phÃºt"
â”‚
â”œâ”€â–º 2:15 PM - TTL háº¿t háº¡n
â”‚   â€¢ Message tá»± Ä‘á»™ng expire
â”‚   â€¢ Chuyá»ƒn qua DLX â†’ cancelled queue
â”‚   â€¢ Consumer xá»­ lÃ½:
â”‚     - Cáº­p nháº­t status = CANCELLED
â”‚     - HoÃ n tráº£ Ä‘iá»‡n thoáº¡i vá» kho
â”‚     - Gá»­i email: "ÄÆ¡n hÃ ng Ä‘Ã£ há»§y do quÃ¡ thá»i gian"
â”‚
â””â”€â–º Káº¿t quáº£: âŒ ÄÆ¡n hÃ ng bá»‹ há»§y tá»± Ä‘á»™ng
```

## ğŸ’¡ Best Practices

```
âœ… NÃŠN:
  â€¢ Set TTL phÃ¹ há»£p vá»›i loáº¡i sáº£n pháº©m
  â€¢ Gá»­i nhiá»u láº§n nháº¯c nhá»Ÿ (5 phÃºt, 2 phÃºt, 30 giÃ¢y)
  â€¢ Log Ä‘áº§y Ä‘á»§ Ä‘á»ƒ debug
  â€¢ CÃ³ retry mechanism cho consumer
  â€¢ Monitor queue depth
  â€¢ Backup database thÆ°á»ng xuyÃªn

âŒ KHÃ”NG NÃŠN:
  â€¢ Set TTL quÃ¡ ngáº¯n (< 5 phÃºt)
  â€¢ KhÃ´ng validate input
  â€¢ Bá» qua error handling
  â€¢ Hard-code config
  â€¢ KhÃ´ng test trÆ°á»›c khi deploy
  â€¢ QuÃªn enable durable queues
```

---

**ğŸ’­ Ghi chÃº:** Táº¥t cáº£ diagram trÃªn Ä‘Ã¢y Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ dá»… hiá»ƒu vÃ  trá»±c quan hÃ³a toÃ n bá»™ luá»“ng xá»­ lÃ½ cá»§a há»‡ thá»‘ng tá»± Ä‘á»™ng há»§y Ä‘Æ¡n hÃ ng sá»­ dá»¥ng RabbitMQ.
