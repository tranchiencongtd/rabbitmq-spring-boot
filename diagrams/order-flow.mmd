flowchart TD
    Start([Khách hàng tạo đơn hàng]) --> CreateOrder[POST /api/orders/create]
    CreateOrder --> GenerateOrder[Tạo Order<br/>status = PENDING]
    GenerateOrder --> SendPending[Gửi message vào queue<br/>TTL = 15 phút]
    SendPending --> QueuePending[(order.pending.queue<br/>TTL = 15 phút)]
    
    QueuePending --> Timer[⏰ Đếm ngược 15 phút]
    
    Timer --> RaceCondition{Khách hàng<br/>làm gì?}
    
    %% Case 1: Thanh toán
    RaceCondition -->|Thanh toán| PayAPI[POST /orders/:id/pay]
    PayAPI --> UpdatePaid[Cập nhật status = PAID]
    UpdatePaid --> EndPaid([✅ ĐÃ THANH TOÁN])
    
    %% Case 2: Hủy thủ công
    RaceCondition -->|Hủy đơn| CancelAPI[POST /orders/:id/cancel]
    CancelAPI --> UpdateManualCancel[Cập nhật status = CANCELLED]
    UpdateManualCancel --> EndManualCancel([❌ ĐÃ HỦY])
    
    %% Case 3: Hết hạn - Tự động hủy
    RaceCondition -->|Không làm gì<br/>Hết 15 phút| Expire[Message HẾT HẠN]
    Expire --> DLX[Dead Letter Exchange]
    DLX --> QueueCancelled[(order.cancelled.queue)]
    QueueCancelled --> ConsumerCancel[Consumer xử lý hủy đơn]
    
    ConsumerCancel --> CheckStatus{Kiểm tra<br/>status hiện tại}
    
    CheckStatus -->|PAID| Ignore[Bỏ qua<br/>Đã thanh toán rồi]
    Ignore --> EndIgnore([✅ GIỮ PAID])
    
    CheckStatus -->|PENDING| AutoCancel[Cập nhật status = CANCELLED<br/>Lý do: Timeout]
    AutoCancel --> EndAutoCancel([❌ TỰ ĐỘNG HỦY])
    
    CheckStatus -->|CANCELLED| AlreadyCancelled[Đã hủy rồi]
    AlreadyCancelled --> EndAlready([❌ ĐÃ HỦY])
    
    %% Styling
    style Start fill:#4f46e5,color:#fff
    style EndPaid fill:#10b981,color:#fff
    style EndIgnore fill:#10b981,color:#fff
    style EndManualCancel fill:#ef4444,color:#fff
    style EndAutoCancel fill:#ef4444,color:#fff
    style EndAlready fill:#6b7280,color:#fff
    
    style QueuePending fill:#fef3c7,stroke:#f59e0b,stroke-width:2px
    style QueueCancelled fill:#fee2e2,stroke:#ef4444,stroke-width:2px
    style DLX fill:#fca5a5,stroke:#dc2626,stroke-width:2px
    
    style RaceCondition fill:#dbeafe,stroke:#3b82f6,stroke-width:3px
    style CheckStatus fill:#fef3c7,stroke:#f59e0b,stroke-width:2px