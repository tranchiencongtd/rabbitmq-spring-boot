```mermaid
sequenceDiagram
    participant C as Khách hàng
    participant API as REST API
    participant P as Producer
    participant Q as RabbitMQ
    participant CON as Consumer
    participant DB as Database
    
    Note over C,DB: SCENARIO 1: THANH TOÁN THÀNH CÔNG
    
    C->>+API: POST /api/orders/create
    API->>API: Tạo Order (status=PENDING)
    API->>+P: sendOrderToPending()
    P->>+Q: Gửi message vào pending queue (TTL=15min)
    Q-->>-P: ACK
    P-->>-API: Success
    API-->>-C: Response: orderId, TTL info
    
    Q->>+CON: Deliver message
    CON->>DB: Lưu order
    CON->>C: Gửi email nhắc nhở
    CON-->>-Q: ACK
    
    Note over C,DB: Khách hàng thanh toán trong 15 phút
    
    C->>+API: POST /api/orders/{id}/pay
    API->>API: Kiểm tra status
    API->>+P: sendOrderToPaid()
    P->>+Q: Gửi message vào paid queue
    Q-->>-P: ACK
    P-->>-API: Success
    API-->>-C: Response: Thanh toán thành công
    
    Q->>+CON: Deliver message (paid queue)
    CON->>DB: Update status = PAID
    CON->>C: Gửi email xác nhận
    CON-->>-Q: ACK
    
    Note over Q: Message trong pending queue expire
    Q->>+CON: Deliver expired message
    CON->>CON: Kiểm tra status = PAID
    CON->>CON: Bỏ qua hủy đơn
    CON-->>-Q: ACK
    
    Note over C,DB: Kết quả: Đơn hàng = PAID ✅
```
